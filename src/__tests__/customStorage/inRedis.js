var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},t=require("ioredis"),r=require("tslib").__importDefault;Object.defineProperty(exports,"__esModule",{value:!0});var n=void 0;exports.InRedisStorage=n;var i={};Object.defineProperty(i,"__esModule",{value:!0});var o,u,a,s,c,f,l,p,d,y,h,m,v,g,_,b,O,S,P,w,N,x,k,j,T={};!function(t){var r="object"==typeof e?e:"object"==typeof self?self:"object"==typeof this?this:{};function n(e,t){return e!==r&&("function"==typeof Object.create?Object.defineProperty(e,"__esModule",{value:!0}):e.__esModule=!0),function(r,n){return e[r]=t?t(r,n):n}}t("object"==typeof T?n(r,n(T)):n(r))}((function(e){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])};o=function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)},u=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},a=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r},s=function(e,t,r,n){var i,o=arguments.length,u=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)u=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(u=(o<3?i(u):o>3?i(t,r,u):i(t,r))||u);return o>3&&u&&Object.defineProperty(t,r,u),u},c=function(e,t){return function(r,n){t(r,n,e)}},f=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},l=function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function u(e){try{s(n.next(e))}catch(e){o(e)}}function a(e){try{s(n.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,a)}s((n=n.apply(e,t||[])).next())}))},p=function(e,t){var r,n,i,o,u={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return u.label++,{value:o[1],done:!1};case 5:u.label++,n=o[1],o=[0];continue;case 7:o=u.ops.pop(),u.trys.pop();continue;default:if(!(i=u.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){u=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){u.label=o[1];break}if(6===o[0]&&u.label<i[1]){u.label=i[1],i=o;break}if(i&&u.label<i[2]){u.label=i[2],u.ops.push(o);break}i[2]&&u.ops.pop(),u.trys.pop();continue}o=t.call(e,u)}catch(e){o=[6,e],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},d=function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||j(t,e,r)},j=Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]},y=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},h=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),u=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)u.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return u},m=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(h(arguments[t]));return e},v=function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<r;t++)for(var o=arguments[t],u=0,a=o.length;u<a;u++,i++)n[i]=o[u];return n},g=function(e,t){for(var r=0,n=t.length,i=e.length;r<n;r++,i++)e[i]=t[r];return e},_=function(e){return this instanceof _?(this.v=e,this):new _(e)},b=function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,i=r.apply(e,t||[]),o=[];return n={},u("next"),u("throw"),u("return"),n[Symbol.asyncIterator]=function(){return this},n;function u(e){i[e]&&(n[e]=function(t){return new Promise((function(r,n){o.push([e,t,r,n])>1||a(e,t)}))})}function a(e,t){try{(r=i[e](t)).value instanceof _?Promise.resolve(r.value.v).then(s,c):f(o[0][2],r)}catch(e){f(o[0][3],e)}var r}function s(e){a("next",e)}function c(e){a("throw",e)}function f(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}},O=function(e){var t,r;return t={},n("next"),n("throw",(function(e){throw e})),n("return"),t[Symbol.iterator]=function(){return this},t;function n(n,i){t[n]=e[n]?function(t){return(r=!r)?{value:_(e[n](t)),done:"return"===n}:i?i(t):t}:i}},S=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=y(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise((function(n,i){(function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)})(n,i,(t=e[r](t)).done,t.value)}))}}},P=function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e};var r=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};w=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&j(t,e,n);return r(t,e),t},N=function(e){return e&&e.__esModule?e:{default:e}},x=function(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)},k=function(e,t,r){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,r),r},e("__extends",o),e("__assign",u),e("__rest",a),e("__decorate",s),e("__param",c),e("__metadata",f),e("__awaiter",l),e("__generator",p),e("__exportStar",d),e("__createBinding",j),e("__values",y),e("__read",h),e("__spread",m),e("__spreadArrays",v),e("__spreadArray",g),e("__await",_),e("__asyncGenerator",b),e("__asyncDelegator",O),e("__asyncValues",S),e("__makeTemplateObject",P),e("__importStar",w),e("__importDefault",N),e("__classPrivateFieldGet",x),e("__classPrivateFieldSet",k)}));var E=T.__importDefault(t),I={};Object.defineProperty(I,"__esModule",{value:!0});var K=(C=void 0,R=I.endsWith=C,M=I.find=R,D=I.findIndex=M,F=I.forOwn=D,A=I.get=F,L=I.groupBy=A,G=I.isBoolean=L,J=I.isFiniteNumber=G,W=I.isIntegerNumber=J,Q=I.isNaNNumber=W,B=I.isObject=Q,V=I.isString=B,z=I.merge=V,$=I.shallowClone=z,U=I.startsWith=$,Y=I.toNumber=U,H=I.toString=Y,Z=I.uniq=H,I.uniqAsStrings=Z);I.uniqueId=K;var C=function(e,t,r){return void 0===r&&(r=!1),!(!X(e)||!X(t))&&(r&&(e=e.toLowerCase(),t=t.toLowerCase()),e.slice(e.length-t.length)===t)};I.endsWith=C;var R=function(e,t){var r;if(q(e))for(var n=Object.keys(e),i=0;i<n.length&&!r;i++){var o=n[i];t(e[o],o,e)&&(r=e[o])}else if(Array.isArray(e))for(i=0;i<e.length&&!r;i++){t(e[i],i,e)&&(r=e[i])}return r};I.find=R;var M=function(e,t){if(Array.isArray(e)&&"function"==typeof t)for(var r=0;r<e.length;r++)if(!0===t(e[r],r,e))return r;return-1};I.findIndex=M;var D=function(e,t){return Object.keys(e).forEach((function(r){return t(e[r],r,e)})),e};I.forOwn=D;var F=function(e,t,r){var n=r;try{var i=t.split("."),o=e;i.forEach((function(e){return o=o[e]})),void 0!==o&&(n=o)}catch(e){}return n};I.get=F;var A=function(e,t){var r={};if(Array.isArray(e)&&X(t))for(var n=0;n<e.length;n++){var i=e[n][t];X(i)&&(r[i]||(r[i]=[]),r[i].push(e[n]))}return r};I.groupBy=A;var L=function(e){return!0===e||!1===e};I.isBoolean=L;var G=function(e){return e instanceof Number&&(e=e.valueOf()),"number"==typeof e&&(Number.isFinite?Number.isFinite(e):isFinite(e))};I.isFiniteNumber=G;var J=function(e){return e instanceof Number&&(e=e.valueOf()),"number"==typeof e&&(Number.isInteger?Number.isInteger(e):isFinite(e)&&Math.floor(e)===e)};I.isIntegerNumber=J;var W=function(e){return e instanceof Number&&(e=e.valueOf()),e!=e};function q(e){return null!==e&&"object"==typeof e&&e.constructor===Object}I.isNaNNumber=W;var Q=q;function X(e){return"string"==typeof e||e instanceof String}I.isObject=Q;var B=X;I.isString=B;var V=function e(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];var o=t;if(q(r)&&Object.keys(r).forEach((function(t){var n=r[t];q(n)&&(n=o[t]&&q(o[t])?e({},o[t],n):e({},n)),void 0!==n&&(o[t]=n)})),n&&n.length){var u=n.splice(0,1)[0];o=e.apply(void 0,T.__spreadArrays([o,u],n))}return o};I.merge=V;var z=function(e){for(var t=Object.keys(e),r={},n=0;n<t.length;n++)r[t[n]]=e[t[n]];return r};I.shallowClone=z;var $=function(e,t){return!(!X(e)||!X(t))&&e.slice(0,t.length)===t};I.startsWith=$;var U=function(e){if("number"==typeof e)return e;if(q(e)&&"function"==typeof e.valueOf){var t=e.valueOf();e=q(t)?t+"":t}return"string"!=typeof e?0===e?e:+e:+(e=e.replace(/^\s+|\s+$/g,""))};I.toNumber=U;var Y=function(e){if(null==e)return"";if("string"==typeof e)return e;if(Array.isArray(e))return e.map((function(e){return X(e)?e:""}))+"";var t=e+"";return"0"===t&&1/e===Number.NEGATIVE_INFINITY?"-0":t};I.toString=Y;var H=function(e){var t={};return e.filter((function(e){return!Object.prototype.hasOwnProperty.call(t,e)&&(t[e]=!0)}))};I.uniq=H;var Z=function(e,t){void 0===t&&(t=JSON.stringify);var r={};return e.filter((function(e){var n=t(e);return!Object.prototype.hasOwnProperty.call(r,n)&&(r[n]=!0)}))};I.uniqAsStrings=Z;var ee=-1;K=function(){return ee++},I.uniqueId=K;var te={};Object.defineProperty(te,"__esModule",{value:!0});var re=(ie=void 0,oe=te.SetPoly=ie,ae=te.setToArray=oe,te.__getSetConstructor=ae);te._Set=re;var ne=function(){function e(e){var t=this;this.__setData__=[],Array.isArray(e)&&e.forEach((function(e){t.add(e)}))}return e.prototype.clear=function(){this.__setData__.length&&(this.__setData__.length=0)},e.prototype.add=function(e){return this.has(e)||this.__setData__.push(e),this},e.prototype.delete=function(e){var t=this.__setData__.indexOf(e);return-1!==t&&(this.__setData__.splice(t,1),!0)},e.prototype.has=function(e){return-1!==this.__setData__.indexOf(e)},e.prototype.forEach=function(e,t){if("function"!=typeof e)throw new TypeError(e+" is not a function");for(var r=0;r<this.__setData__.length;r++){var n=this.__setData__[r];e.call(t,n,n,this)}},Object.defineProperty(e.prototype,"size",{get:function(){return this.__setData__.length},enumerable:!1,configurable:!0}),e}(),ie=ne;te.SetPoly=ie;var oe=function(e){return e instanceof ne?e.__setData__.slice():Array.from(e)};function ue(){return"function"==typeof Array.from&&"function"==typeof Set&&Set.prototype&&Set.prototype.values?Set:ne}te.setToArray=oe;var ae=ue;te.__getSetConstructor=ae,re=ue(),te._Set=re;var se={};Object.defineProperty(se,"__esModule",{value:!0});se.default=function(e){return null!=e&&"function"==typeof e.then};var ce=T.__importDefault(se),fe={};Object.defineProperty(fe,"__esModule",{value:!0});var le=function(e,t){return e<1?t:new Promise((function(r,n){var i=setTimeout((function(){n(new Error("Operation timed out because it exceeded the configured time limit of "+e+"ms."))}),e);t.then((function(e){clearTimeout(i),r(e)}),(function(e){clearTimeout(i),n(e)}))}))};fe.default=le;var pe=T.__importDefault(fe),de=["set","exec","del","get","keys","sadd","srem","sismember","smembers","incr","rpush","pipeline","expire","mget","lrange","ltrim"],ye={connectionTimeout:1e4,operationTimeout:5e3},he={enableOfflineQueue:!1,connectTimeout:ye.connectionTimeout,lazyConnect:!1},me=function(e){function t(r,n){var i=this,o=t._defineOptions(n);return(i=e.apply(this,t._defineLibrarySettings(o))||this).log=r,i._options=o,i._notReadyCommandsQueue=[],i._runningCommands=new te._Set,i._listenToEvents(),i._setTimeoutWrappers(),i._setDisconnectWrapper(),i}return T.__extends(t,e),t.prototype._listenToEvents=function(){var e=this;this.once("ready",(function(){var t=e._notReadyCommandsQueue?e._notReadyCommandsQueue.length:0;e.log.info("storage:redis-adapter: Redis connection established. Queued commands: "+t+"."),e._notReadyCommandsQueue&&e._notReadyCommandsQueue.forEach((function(t){e.log.info("storage:redis-adapter: Executing queued "+t.name+" command."),t.command().then(t.resolve).catch(t.reject)})),e._notReadyCommandsQueue=void 0})),this.once("close",(function(){e.log.info("storage:redis-adapter: Redis connection closed.")}))},t.prototype._setTimeoutWrappers=function(){var e=this;de.forEach((function(t){var r=e[t];e[t]=function(){var n=arguments;function i(){e.log.debug("storage:redis-adapter: Executing "+t+".");var i=r.apply(e,n);if(ce.default(i)){e._runningCommands.add(i);var o=function(){e._runningCommands.delete(i)};return i.then(o,o),pe.default(e._options.operationTimeout,i).catch((function(r){throw e.log.error("storage:redis-adapter: "+t+" operation threw an error or exceeded configured timeout of "+e._options.operationTimeout+"ms. Message: "+r),r}))}return i}return e._notReadyCommandsQueue?new Promise((function(r,n){e._notReadyCommandsQueue.unshift({resolve:r,reject:n,command:i,name:t.toUpperCase()})})):i()}}))},t.prototype._setDisconnectWrapper=function(){var e=this,t=e.disconnect;e.disconnect=function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];setTimeout((function(){e._runningCommands.size>0?(e.log.info("storage:redis-adapter: Attempting to disconnect but there are "+e._runningCommands.size+" commands still waiting for resolution. Defering disconnection until those finish."),Promise.all(te.setToArray(e._runningCommands)).then((function(){e.log.debug("storage:redis-adapter: Pending commands finished successfully, disconnecting."),t.apply(e,r)})).catch((function(n){e.log.warn("storage:redis-adapter: Pending commands finished with error: "+n+". Proceeding with disconnection."),t.apply(e,r)}))):(e.log.debug("storage:redis-adapter: No commands pending execution, disconnect."),t.apply(e,r))}),10)}},t._defineLibrarySettings=function(e){var t=I.merge({},he),r=[t];return I.isString(e.url)?r.unshift(e.url):I.merge(t,{host:e.host,port:e.port,db:e.db,password:e.pass}),r},t._defineOptions=function(e){var t={connectionTimeout:e.connectionTimeout,operationTimeout:e.operationTimeout,url:e.url,host:e.host,port:e.port,db:e.db,pass:e.pass};return I.merge({},ye,t)},t}(E.default);i.default=me;var ve=r(i),ge={};Object.defineProperty(ge,"__esModule",{value:!0});var _e=void 0;ge.validatePrefix=_e;var be=/[^.]+$/;_e=function(e){return e&&"string"==typeof e?I.endsWith(e,".SPLITIO")?e:e+".SPLITIO":"SPLITIO"},ge.validatePrefix=_e;var Oe=function(){function e(e){void 0===e&&(e="SPLITIO"),this.prefix=e}return e.prototype.buildTrafficTypeKey=function(e){return this.prefix+".trafficType."+e},e.prototype.buildSplitKey=function(e){return this.prefix+".split."+e},e.prototype.buildSplitsTillKey=function(){return this.prefix+".splits.till"},e.prototype.isSplitKey=function(e){return I.startsWith(e,this.prefix+".split.")},e.prototype.buildSplitKeyPrefix=function(){return this.prefix+".split."},e.prototype.buildSplitsWithSegmentCountKey=function(){return this.prefix+".splits.usingSegments"},e.prototype.buildSegmentNameKey=function(e){return this.prefix+".segment."+e},e.prototype.buildSegmentTillKey=function(e){return this.prefix+".segment."+e+".till"},e.prototype.extractKey=function(e){var t=e.match(be);if(t&&t.length)return t[0];throw new Error("Invalid latency key provided")},e}();ge.default=Oe;var Se={};Object.defineProperty(Se,"__esModule",{value:!0});var Pe=function(e){function t(t,r){var n=e.call(this,t)||this;return n.metadata=r,n}return T.__extends(t,e),t.prototype.buildRegisteredSegmentsKey=function(){return this.prefix+".segments.registered"},t.prototype.buildVersionablePrefix=function(){return this.prefix+"/"+this.metadata.s+"/"+this.metadata.i},t.prototype.buildImpressionsKey=function(){return this.prefix+".impressions"},t.prototype.buildEventsKey=function(){return this.prefix+".events"},t.prototype.buildLatencyKeyPrefix=function(){return this.buildVersionablePrefix()+"/latency"},t.prototype.buildLatencyKey=function(e,t){return this.buildLatencyKeyPrefix()+"."+e+".bucket."+t},t.prototype.buildCountKey=function(e){return this.buildVersionablePrefix()+"/count."+e},t.prototype.searchPatternForSplitKeys=function(){return this.buildSplitKeyPrefix()+"*"},t}(T.__importDefault(ge).default);Se.default=Pe;var we=r(Se),Ne={};Object.defineProperty(Ne,"__esModule",{value:!0});var xe={};Object.defineProperty(xe,"__esModule",{value:!0});var ke=(je=void 0,xe.LOG_PREFIX=je);xe.DEFINED=ke;var je="storage:localstorage: ";xe.LOG_PREFIX=je,ke="1",xe.DEFINED=ke;var Te={};Object.defineProperty(Te,"__esModule",{value:!0});var Ee=function(){function e(){}return e.prototype.usesSegments=function(){return Promise.resolve(!0)},e.prototype.checkCache=function(){return Promise.resolve(!1)},e.prototype.killLocally=function(e,t,r){var n=this;return this.getSplit(e).then((function(i){if(i){var o=JSON.parse(i);if(!o.changeNumber||o.changeNumber<r){o.killed=!0,o.defaultTreatment=t,o.changeNumber=r;var u=JSON.stringify(o);return n.addSplit(e,u)}}return!1})).catch((function(){return!1}))},e}();function Ie(e){return e.reduce((function(e,t){return null===t[0]&&e.push(t[1]),e}),[])}Te.default=Ee;var Ke=function(e){function t(t,r,n){var i=e.call(this)||this;return i.log=t,i.redis=n,i.keys=r,i.redis.on("error",(function(e){i.redisError=e})),i.redis.on("connect",(function(){i.redisError=void 0})),i}return T.__extends(t,e),t.prototype._decrementCounts=function(e){if(e.trafficTypeName){var t=this.keys.buildTrafficTypeKey(e.trafficTypeName);return this.redis.decr(t)}},t.prototype._incrementCounts=function(e){if(e.trafficTypeName){var t=this.keys.buildTrafficTypeKey(e.trafficTypeName);return this.redis.incr(t)}},t.prototype.addSplit=function(e,t){var r=this,n=this.keys.buildSplitKey(e);return this.redis.get(n).then((function(e){var i,o;try{i=e?JSON.parse(e):void 0,o=JSON.parse(t)}catch(e){throw new Error("Error parsing split definition: "+e)}return Promise.all([r.redis.set(n,t),r._incrementCounts(o),i&&r._decrementCounts(i)])})).then((function(e){return"OK"===e[0]}))},t.prototype.addSplits=function(e){var t=this;return Promise.all(e.map((function(e){return t.addSplit(e[0],e[1])})))},t.prototype.removeSplit=function(e){var t=this;return this.getSplit(e).then((function(r){if(r){var n=JSON.parse(r);t._decrementCounts(n)}return t.redis.del(t.keys.buildSplitKey(e))}))},t.prototype.removeSplits=function(e){var t=this;return Promise.all(e.map((function(e){return t.removeSplit(e)})))},t.prototype.getSplit=function(e){return this.redisError?(this.log.error(xe.LOG_PREFIX+this.redisError),Promise.reject(this.redisError)):this.redis.get(this.keys.buildSplitKey(e))},t.prototype.setChangeNumber=function(e){return this.redis.set(this.keys.buildSplitsTillKey(),e+"").then((function(e){return"OK"===e}))},t.prototype.getChangeNumber=function(){var e=this;return this.redis.get(this.keys.buildSplitsTillKey()).then((function(e){var t=parseInt(e,10);return I.isNaNNumber(t)?-1:t})).catch((function(t){return e.log.error(xe.LOG_PREFIX+"Could not retrieve changeNumber from storage. Error: "+t),-1}))},t.prototype.getAll=function(){var e=this;return this.redis.keys(this.keys.searchPatternForSplitKeys()).then((function(t){return e.redis.pipeline(t.map((function(e){return["get",e]}))).exec()})).then(Ie)},t.prototype.getSplitNames=function(){var e=this;return this.redis.keys(this.keys.searchPatternForSplitKeys()).then((function(t){return t.map(e.keys.extractKey)}))},t.prototype.trafficTypeExists=function(e){var t=this;return this.redis.get(this.keys.buildTrafficTypeKey(e)).then((function(r){return null!==r&&(r=parseInt(r,10),!I.isFiniteNumber(r)||r<0?(t.log.info(xe.LOG_PREFIX+"Could not validate traffic type existance of "+e+" due to data corruption of some sorts."),!1):r>0)})).catch((function(r){return t.log.error(xe.LOG_PREFIX+"Could not validate traffic type existance of "+e+" due to an error: "+r+"."),!0}))},t.prototype.clear=function(){return this.redis.flushdb().then((function(e){return"OK"===e}))},t.prototype.getSplits=function(e){var t,r=this;if(this.redisError)return this.log.error(xe.LOG_PREFIX+this.redisError),Promise.reject(this.redisError);var n={},i=e.map((function(e){return r.keys.buildSplitKey(e)}));return(t=this.redis).mget.apply(t,i).then((function(t){return e.forEach((function(e,r){n[e]=t[r]})),Promise.resolve(n)})).catch((function(e){return r.log.error(xe.LOG_PREFIX+"Could not grab splits due to an error: "+e+"."),Promise.reject(e)}))},t}(T.__importDefault(Te).default);Ne.default=Ke;var Ce=r(Ne),Re={};Object.defineProperty(Re,"__esModule",{value:!0});var Me=function(){function e(e,t,r){this.log=e,this.redis=r,this.keys=t}return e.prototype.addToSegment=function(e,t){var r=this.keys.buildSegmentNameKey(e);return t.length?this.redis.sadd(r,t).then((function(){return!0})):Promise.resolve(!0)},e.prototype.removeFromSegment=function(e,t){var r=this.keys.buildSegmentNameKey(e);return t.length?this.redis.srem(r,t).then((function(){return!0})):Promise.resolve(!0)},e.prototype.isInSegment=function(e,t){return this.redis.sismember(this.keys.buildSegmentNameKey(e),t).then((function(e){return 0!==e}))},e.prototype.setChangeNumber=function(e,t){return this.redis.set(this.keys.buildSegmentTillKey(e),t+"").then((function(e){return"OK"===e}))},e.prototype.getChangeNumber=function(e){var t=this;return this.redis.get(this.keys.buildSegmentTillKey(e)).then((function(e){var t=parseInt(e,10);return I.isNaNNumber(t)?-1:t})).catch((function(e){return t.log.error(xe.LOG_PREFIX+"Could not retrieve changeNumber from segments storage. Error: "+e),-1}))},e.prototype.registerSegments=function(e){return e.length?this.redis.sadd(this.keys.buildRegisteredSegmentsKey(),e).then((function(){return!0})):Promise.resolve(!0)},e.prototype.getRegisteredSegments=function(){return this.redis.smembers(this.keys.buildRegisteredSegmentsKey())},e.prototype.clear=function(){return this.redis.flushdb().then((function(e){return"OK"===e}))},e}();Re.default=Me;var De=r(Re),Fe={};Object.defineProperty(Fe,"__esModule",{value:!0});var Ae=function(){function e(e,t,r,n){this.log=e,this.key=t,this.redis=r,this.metadata=n}return e.prototype.track=function(e){var t=this;return this.redis.rpush(this.key,this._toJSON(e)).then((function(r){if(r===e.length)return t.redis.expire(t.key,3600)}))},e.prototype._toJSON=function(e){var t=this;return e.map((function(e){var r=e.keyName,n=e.bucketingKey,i=e.feature,o=e.treatment,u=e.label,a=e.time,s=e.changeNumber;return JSON.stringify({m:t.metadata,i:{k:r,b:n,f:i,t:o,r:u,c:s,m:a}})}))},e.prototype.count=function(){return this.redis.llen(this.key).catch((function(){return 0}))},e.prototype.drop=function(e){return e?this.redis.ltrim(this.key,e,-1):this.redis.del(this.key)},e.prototype.popNWithMetadata=function(e){var t=this;return this.redis.lrange(this.key,0,e-1).then((function(e){return t.redis.ltrim(t.key,e.length,-1).then((function(){return t.redis.expire(t.key,3600).catch((function(){})),e.map((function(e){return JSON.parse(e)}))}))}))},e}();Fe.default=Ae;var Le=r(Fe),Ge={};Object.defineProperty(Ge,"__esModule",{value:!0});var Je=function(){function e(e,t,r,n){this.log=e,this.key=t,this.redis=r,this.metadata=n}return e.prototype.track=function(e){var t=this;return this.redis.rpush(this.key,this._toJSON(e)).then((function(){return!0})).catch((function(e){return t.log.error(xe.LOG_PREFIX+"Error adding event to queue: "+e+"."),!1}))},e.prototype._toJSON=function(e){return JSON.stringify({m:this.metadata,e:e})},e.prototype.count=function(){return this.redis.llen(this.key).catch((function(){return 0}))},e.prototype.drop=function(e){return e?this.redis.ltrim(this.key,e,-1):this.redis.del(this.key)},e.prototype.popNWithMetadata=function(e){var t=this;return this.redis.lrange(this.key,0,e-1).then((function(e){return t.redis.ltrim(t.key,e.length,-1).then((function(){return e.map((function(e){return JSON.parse(e)}))}))}))},e}();Ge.default=Je;var We=r(Ge),qe={};Object.defineProperty(qe,"__esModule",{value:!0});var Qe={};Object.defineProperty(Qe,"__esModule",{value:!0});var Xe=function(e,t,r,n){void 0===t&&(t=0),void 0===r&&(r=23),void 0===n&&(n=1.5);var i=Math.min(r,Math.max(t,Math.floor(Math.log(e)/Math.log(n))));return I.isNaNNumber(i)?0:i};Qe.default=Xe;var Be=T.__importDefault(Qe),Ve=function(){function e(e,t){this.keys=e,this.redis=t}return e.prototype.track=function(e,t){var r=Be.default(t);return this.redis.incr(this.keys.buildLatencyKey(e,r)).catch((function(){})).then((function(){return!0}))},e}();qe.default=Ve;var ze=r(qe),$e={};Object.defineProperty($e,"__esModule",{value:!0});var Ue=function(){function e(e,t){this.keys=e,this.redis=t}return e.prototype.track=function(e){return this.redis.incr(this.keys.buildCountKey(e)).catch((function(){})).then((function(){return!0}))},e}();$e.default=Ue;var Ye=r($e);n=function(e){void 0===e&&(e={});var t=ge.validatePrefix(e.prefix);return function(r){var n=r.log,i=r.metadata,o=r.onReadyCb,u=new we.default(t,i),a=new ve.default(n,e.options||{});return a.on("connect",(function(){o&&o()})),{splits:new Ce.default(n,u,a),segments:new De.default(n,u,a),impressions:new Le.default(n,u.buildImpressionsKey(),a,i),events:new We.default(n,u.buildEventsKey(),a,i),latencies:new ze.default(u,a),counts:new Ye.default(u,a),destroy:function(){a.disconnect()}}}},exports.InRedisStorage=n;
//# sourceMappingURL=index.js.map
